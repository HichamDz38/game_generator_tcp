<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Game panel</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <style>
            body {
                background-color: #f5f5fa;
            }

            .navbar {
                padding: 10px 20px;
            }


            .card {
                border-radius: 10px;
            }

        </style>
        <script>
            $(document).ready(function() {
                setInterval("ajaxd()",1000); // call every 10 seconds
                ajaxd();
            });
            function ajaxd() { 
                //reload result into element with id "sysStatus"
                //$("#devices").load("/get_devices", function() {  alert( "New device connected." ); });
                $.ajax({
                    url : '/get_devices',
                    type : 'GET',
                    dataType : 'json',
                    success: function(response) {
                        let connt = '';
                        response = JSON.parse(response.replace(/'/g,'"'));
                        for (const key in response) {
                            connt += `
                            <div class="card p-3 mb-3 shadow-sm">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div><strong>${ key }. ${ response[key]["device_name"] }</strong></div>
                            </div>
                            <div class="d-flex w-100">
                                <div class="d-flex" style="flex: 0 0 49%; gap: 5px;">
                                    <button onclick="sendAction('/reset/${ key }')" class="btn btn-danger btn-sm flex-fill">Reset</button>
                                    <button onclick="sendAction('/activate/${ key }')" class="btn btn-warning btn-sm flex-fill">Activate</button>
                                    <button onclick="sendAction('/finish/${ key }')" class="btn btn-success btn-sm flex-fill">Finish</button>
                                </div>`
                        let cnn =`<div class="d-flex flex-wrap ms-3" style="flex: 0 0 50%; gap: 5px;">`
                        for (let i=0; i< response[key]["num_hints"];i++) {
                            cnn +=`
                            <button onclick="sendHint('${ key }', 'hint${ i }')" class="btn btn-info btn-sm flex-fill">hint ${ i+1 }</button>`;
                        }
                        if (response[key]["num_hints"]>0) {connt += cnn +`</div>`}
                        connt +=
                        `</div>
                        <div id="status-${ key }" class="mt-2">
                            ${ response[key]["status"] }
                        </div></div>`;
                        
                }
                document.getElementById("devices").innerHTML = '';
                document.getElementById("devices").innerHTML= connt;
            },
                    error : function(request,status,error) {
                        console.log(error);
                        console.log(request.responseText);
                    }
                });

                }
                function sendAction(url){
                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: 'json',
                    success: function(response) {
                        console.log('Action sent successfully:', response);
                        if (response.status === 'success') {
                            console.log('Command sent successfully');
                        }
                    },
                    error: function(request, status, error) {
                        console.log('Error sending action:', error);
                        console.log(request.responseText);
                        alert('Error sending command: ' + error);
                    }
                });
            }
                function sendHint(deviceId, hintId) {
                $.ajax({
                    url: `/hint/${deviceId}/${hintId}`,
                    type: 'POST',
                    dataType: 'json',
                    success: function(response) {
                        console.log('Hint sent successfully:', response);
                        if (response.status === 'success') {
                            console.log('Hint sent successfully');
                        }
                    },
                    error: function(request, status, error) {
                        console.log('Error sending hint:', error);
                        console.log(request.responseText);
                        alert('Error sending hint: ' + error);
                    }
                });
            }
                function sendAllAction(url){
                    $.ajax({
                        url: url,
                        type: 'POST',
                        dataType: 'json',
                        success: function(response) {
                            console.log('sent successfully:', response);
                            if (response.status === 'success') {
                                console.log('successfully');
                            }
                        },
                        error: function(request, status, error) {
                            console.log('Error', error);
                            console.log(request.responseText);
                            alert('Error sending' + error);
                        }
                    });
                }
            </script>


    </head>
    <body class="bg-light">

        <div class="container mt-4 text-center">
            <h2>{{ page_title }}</h2>

            <div style="margin-bottom: 20px;">
                <button onclick="sendAllAction('/start_all')" class="btn btn-primary">START GAME</button>
                <button onclick="sendAllAction('/reset_all')" class="btn btn-danger">RESET ALL</button>
            </div>
            <div id="devices">
               
            </div>
        </div>

    </body>
</html>
